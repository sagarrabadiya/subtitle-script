var __awaiter=this&&this.__awaiter||function(t,s,a,c){return new(a=a||Promise)(function(o,e){function n(t){try{r(c.next(t))}catch(t){e(t)}}function i(t){try{r(c.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?o(t.value):((e=t.value)instanceof a?e:new a(function(t){t(e)})).then(n,i)}r((c=c.apply(t,s||[])).next())})},__generator=this&&this.__generator||function(n,i){var r,s,a,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(o){return function(t){var e=[o,t];if(r)throw new TypeError("Generator is already executing.");for(;c;)try{if(r=1,s&&(a=2&e[0]?s.return:e[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,e[1])).done)return a;switch(s=0,(e=a?[2&e[0],a.value]:e)[0]){case 0:case 1:a=e;break;case 4:return c.label++,{value:e[1],done:!1};case 5:c.label++,s=e[1],e=[0];continue;case 7:e=c.ops.pop(),c.trys.pop();continue;default:if(!(a=0<(a=c.trys).length&&a[a.length-1])&&(6===e[0]||2===e[0])){c=0;continue}if(3===e[0]&&(!a||e[1]>a[0]&&e[1]<a[3])){c.label=e[1];break}if(6===e[0]&&c.label<a[1]){c.label=a[1],a=e;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(e);break}a[2]&&c.ops.pop(),c.trys.pop();continue}e=i.call(n,c)}catch(t){e=[6,t],s=0}finally{r=a=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}}},SubtitleGenerator=function(){function e(t){var e,o=this;this.room=t,this.user=t.me.name,this.stream=null,this.bufferSize=2048,this.audioContext=null,this.audioProcessor=null,this.inputStream=null,this.currentGUID=uuid.v4(),this.audioMutedEvent=this.audioMutedEvent.bind(this),this.audioUnmutedEvent=this.audioUnmutedEvent.bind(this),t.addEventListener("user-audio-muted",this.audioMutedEvent),t.addEventListener("user-audio-unmuted",this.audioUnmutedEvent),0<t.localStreams.size()&&(e=!1,t.localStreams.forEach(function(t){!t.ifAudio()||t.ifScreen()||e||(o.setStream(t.audioStream.clone()),e=!0)}))}return e.prototype.audioMutedEvent=function(t){t.clientId===this.room.clientId&&this.pause()},e.prototype.audioUnmutedEvent=function(t){t.clientId===this.room.clientId&&this.resume()},e.prototype.setStream=function(t){this.stream=t},e.prototype.startSocketStream=function(){this.socket.emit("start-stream",{config:{encoding:"LINEAR16",sampleRateHertz:16e3,languageCode:this.languageCode,profanityFilter:!1,enableWordTimeOffsets:!0},interimResults:!0})},e.prototype.stopSocketStream=function(){this.socket.emit("end-stream","")},e.prototype.createAudioProcessor=function(t){var e=this,t=(this.languageCode=t=void 0===t?"en-IN":t,this.startSocketStream(),window.AudioContext||window.webkitAudioContext);this.audioContext=new t({latencyHint:"interactive"}),this.audioProcessor=this.audioContext.createScriptProcessor(this.bufferSize,1,1),this.audioProcessor.connect(this.audioContext.destination),this.audioContext.resume(),this.inputStream=this.audioContext.createMediaStreamSource(this.stream),this.inputStream.connect(this.audioProcessor),this.audioProcessor.onaudioprocess=function(t){e.microphoneProcess(t)},this.setSilenceDetector(this.stream,this.audioContext)},e.prototype.microphoneProcess=function(t){this.isRecording&&(t=t.inputBuffer.getChannelData(0),t=e.convertFloat32ToInt16(t),this.socket.emit("mic-data",t))},e.convertFloat32ToInt16=function(t){for(var e=t.length,o=new Int16Array(e/3);e--;)e%3==0&&(o[e/3]=65535*t[e]);return o.buffer},e.prototype.getSocketURL=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,new Promise(function(o){window.addEventListener("message",function t(e){e="string"==typeof e.data?JSON.parse(e.data):e;e&&e.data.socket&&(o({host:e.data.socket.host,path:e.data.socket.path,language:e.data.socket.language}),window.removeEventListener("message",t))}),window.parent.postMessage({socketUrl:!0},"*")})]})})},e.prototype.connectSocket=function(){var n=this;return this.getSocketURL().then(function(t){var e=io(t.host,{autoConnect:!1,path:t.path});return e.connect(),e.on("connect",function(){n.userId=e.id,e.emit("user",n.user)}),e.on("transcript",function(t){var t="en-IN"===n.languageCode?t.toLowerCase():t,e={enx_action:"signal",enx_data:{action:"local-subtitle",payload:{uuid:n.currentGUID,text:t,user:n.user}}},o=(n.room.sendUserData(e,!1,[n.room.clientId]),Array.from(n.room.userList.keys()).filter(function(t){return t!==n.room.clientId})),e={enx_action:"signal",enx_data:{action:"remote-subtitle",payload:{uuid:n.currentGUID,text:t,user:n.user}}};n.room.sendUserData(e,!1,o),console.log("".concat(n.user,": ").concat(t))}),e.on("transcript-finished",function(){var t={enx_action:"signal",enx_data:{action:"hide-subtitle",payload:{uuid:n.currentGUID}}};n.room.sendUserData(t,!1,[n.room.clientId]),n.currentGUID=uuid.v4()}),e.on("stream-error",function(t){n.destroy(),console.error(t)}),e.on("disconnect",function(){console.log("socket disconnected")}),n.socket=e,t})},e.prototype.stop=function(){this.isRecording=!1,this.stopSocketStream(),this.beforeDestroy()},e.prototype.start=function(t){var e=this;t&&this.setStream(t),this.connectSocket().then(function(t){e.isRecording=!0,e.createAudioProcessor(t.language||"en-IN")})},e.prototype.setSilenceDetector=function(t){var e=new AudioContext,o=e.createAnalyser(),n=(e.createMediaStreamSource(t).connect(o),o.minDecibels=-80,new Uint8Array(o.frequencyBinCount)),i=performance.now(),r=!1,s=this;!function t(e){requestAnimationFrame(t),o.getByteFrequencyData(n),n.some(function(t){return t})&&(r&&(r=!1,s.startSocketStream()),i=e),!r&&500<e-i&&(s.stopSocketStream(),r=!0)}()},e.prototype.pause=function(){this.stopSocketStream(),this.isRecording=!1,this.stream.getTracks().forEach(function(t){return t.enabled=!1})},e.prototype.resume=function(){this.startSocketStream(),this.isRecording=!0,this.stream.getTracks().forEach(function(t){return t.enabled=!0})},e.prototype.beforeDestroy=function(){var t=this;if(this.stopSocketStream(),this.isRecording=!1,this.socket.off("transcript"),this.socket.off("stream-error"),this.audioProcessor){if(this.inputStream)try{this.inputStream.disconnect(this.audioProcessor)}catch(t){console.warn("Attempt to disconnect input failed.")}this.audioProcessor.disconnect(this.audioContext.destination)}this.audioContext&&this.audioContext.close().then(function(){t.inputStream=null,t.audioProcessor=null,t.audioContext=null})},e.prototype.destroy=function(){this.isRecording=!1,this.beforeDestroy(),this.stream.getTracks().forEach(function(t){return t.stop()}),this.socket.disconnect(),this.room.addEventListener("user-audio-muted",this.audioMutedEvent),this.room.addEventListener("user-audio-unmuted",this.audioUnmutedEvent)},e}();